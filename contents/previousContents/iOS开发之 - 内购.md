# iOSå¼€å‘ä¹‹ - å†…è´­

> ç”µå•†ä¹‹ç±»çš„ app å¤§å¤šç”¨çš„éƒ½æ˜¯ç¬¬ä¸‰æ–¹æ”¯ä»˜ï¼ˆæ”¯ä»˜å®å¾®ä¿¡ç­‰æ”¯ä»˜ï¼‰ï¼Œä½†æ˜¯åœ¨æŸç§ç‰¹æ®Šæƒ…å†µä¹‹ä¸‹ï¼Œæˆ‘ä»¬å´ä¸å¾—ä¸ä½¿ç”¨å†…è´­ã€‚æ¯”å¦‚å•†å“æ˜¯åœ¨æœ¬ app ä¸­ä½¿ç”¨å’Œæ¶ˆè€—çš„ï¼ˆæ¸¸æˆå¸æ¸¸æˆé“å…·ç­‰ï¼‰ï¼Œå°±ä¸€å®šè¦ç”¨å†…è´­ï¼Œè‹¹æœå¼ºåˆ¶çš„ï¼Œå¦åˆ™ä¼šè¢«æ‹’ç»ä¸Šçº¿ã€‚å› æ­¤ä½œä¸º iOS å¼€å‘è€…ï¼Œä¸å…‰è¦äº†è§£ç¬¬ä¸‰æ–¹æ”¯ä»˜ï¼Œå¯¹å†…è´­ä¹Ÿè¦æœ‰ä¸€å®šçš„è®¤è¯†ï¼

##ä¸€ã€ä»€ä¹ˆæ˜¯å†…è´­ï¼Ÿ
å†…è´­æ˜¯è‹¹æœæ¨å‡ºçš„ä¸€ç§æ”¯ä»˜æ–¹å¼ã€‚è¯´ç™½äº†å†…è´­å°±æ˜¯è‹¹æœè·å–åˆ©æ¶¦çš„æ–¹å¼ä¹‹ä¸€ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜ï¼Œåªä¼šæ”¯ä»˜å°‘é‡çš„ğŸ’°ï¼Œä½†ä½¿ç”¨å†…è´­å´è¦æ”¯ä»˜å¾ˆå¤šğŸ’°ğŸ’°ğŸ’°ğŸ’°ğŸ’°ğŸ’°ğŸ’°ğŸ’°ï¼Œè¦å’Œè‹¹æœä¸‰ä¸ƒåˆ†å¸ï¼ˆä»¥å‰æ˜¯å››å…­åˆ†ğŸ˜¢ï¼‰ã€‚

##äºŒã€å†…è´­äº§å“çš„ç±»åˆ«

å®˜æ–¹çš„æ³¨é‡Šå†™çš„å¾ˆæ¸…æ¥šäº†ï¼Œå†…è´­æœ‰äº”ç§äº§å“ç±»åˆ«ï¼Œç®€ä»‹å¦‚ä¸‹ï¼š
- éæ¶ˆè€—å“ï¼ˆNonconsumableï¼‰
æŒ‡çš„æ˜¯åœ¨æ¸¸æˆä¸­ä¸€æ¬¡æ€§è´­ä¹°å¹¶æ‹¥æœ‰æ°¸ä¹…è®¿é—®æƒçš„ç‰©å“æˆ–æœåŠ¡ã€‚éæ¶ˆè€—å“ç‰©å“å¯ä»¥è¢«ç”¨æˆ·å†æ¬¡ä¸‹è½½ï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨ç”¨æˆ·çš„æ‰€æœ‰è®¾å¤‡ä¸Šä½¿ç”¨ã€‚
- æ¶ˆè€—å“ï¼ˆConsumableï¼‰
æ¶ˆè€—å“è´­ä¹°ä¸å¯è¢«å†æ¬¡ä¸‹è½½,æ ¹æ®å…¶ç‰¹ç‚¹,æ¶ˆè€—å“ä¸èƒ½åœ¨ç”¨æˆ·çš„è®¾å¤‡ä¹‹é—´è·¨è®¾å¤‡ä½¿ç”¨,é™¤éè‡ªå®šä¹‰æœåŠ¡åœ¨ç”¨æˆ·çš„è´¦å·ä¹‹é—´å…±äº«è¿™äº›ä¿¡æ¯ã€‚
**ä»¥ä¸‹ä¸‰ç§ç±»åˆ«åœ¨iBooksä¸­ä½¿ç”¨ï¼Œç›®å‰iBooksä¸æ”¯æŒå¤§é™†å¸‚åœº**
- å…è´¹è®¢é˜…ï¼ˆFree subscriptionsï¼‰
- è‡ªåŠ¨ç»­è´¹è®¢é˜…ï¼ˆAuto-renewing subscriptionsï¼‰
- éè‡ªåŠ¨ç»­è´¹è®¢é˜…ï¼ˆNonrenewing subscriptionsï¼‰

##ä¸‰ã€è‹¹æœå®˜æ–¹çš„å†…è´­æµç¨‹

![å†…è´­æµç¨‹](http://upload-images.jianshu.io/upload_images/2665449-0614b70007393038.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
- ç™½è¯æ–‡å¦‚ä¸‹â¬‡ï¸


1. ç¨‹åºå‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œè·å¾—ä¸€ä»½äº§å“åˆ—è¡¨ã€‚
2. æœåŠ¡å™¨è¿”å›åŒ…å«äº§å“æ ‡è¯†ç¬¦çš„åˆ—è¡¨ã€‚
3. ç¨‹åºå‘App Storeå‘é€è¯·æ±‚ï¼Œå¾—åˆ°äº§å“çš„ä¿¡æ¯ã€‚
4. App Storeè¿”å›äº§å“ä¿¡æ¯ã€‚
5. ç¨‹åºæŠŠè¿”å›çš„äº§å“ä¿¡æ¯æ˜¾ç¤ºç»™ç”¨æˆ·ï¼ˆAppçš„storeç•Œé¢ï¼‰
6. ç”¨æˆ·é€‰æ‹©æŸä¸ªäº§å“
7. ç¨‹åºå‘App Storeå‘é€æ”¯ä»˜è¯·æ±‚
8. App Storeå¤„ç†æ”¯ä»˜è¯·æ±‚å¹¶è¿”å›äº¤æ˜“å®Œæˆä¿¡æ¯ã€‚
9. ç¨‹åºä»ä¿¡æ¯ä¸­è·å¾—æ•°æ®ï¼Œå¹¶å‘é€è‡³æœåŠ¡å™¨ã€‚
10. æœåŠ¡å™¨çºªå½•æ•°æ®ï¼Œå¹¶è¿›è¡Œå®¡(æˆ‘ä»¬çš„)æŸ¥ã€‚
11. æœåŠ¡å™¨å°†æ•°æ®å‘ç»™App Storeæ¥éªŒè¯è¯¥äº¤æ˜“çš„æœ‰æ•ˆæ€§ã€‚
12. App Storeå¯¹æ”¶åˆ°çš„æ•°æ®è¿›è¡Œè§£æï¼Œè¿”å›è¯¥æ•°æ®å’Œè¯´æ˜å…¶æ˜¯å¦æœ‰æ•ˆçš„æ ‡è¯†ã€‚
13. æœåŠ¡å™¨è¯»å–è¿”å›çš„æ•°æ®ï¼Œç¡®å®šç”¨æˆ·è´­ä¹°çš„å†…å®¹ã€‚
14. æœåŠ¡å™¨å°†è´­ä¹°çš„å†…å®¹ä¼ é€’ç»™ç¨‹åºã€‚

##å››ã€ä»£ç å®ç°
4.1 é¡¹ç›®çš„Bundle identifieréœ€è¦ä¸æ‚¨ç”³è¯·AppIDæ—¶å¡«å†™çš„bundleIDä¸€è‡´ï¼Œä¸ç„¶ä¼šæ— æ³•è¯·æ±‚åˆ°å•†å“ä¿¡æ¯ã€‚

![Bundle identifier](http://upload-images.jianshu.io/upload_images/2665449-4a5e5e9889d10179.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

4.2è¦ä½¿ç”¨å†…è´­,éœ€è¦å¯¼å…¥ StoreKit ä¾èµ–åº“
![å…¥StoreKit](http://upload-images.jianshu.io/upload_images/2665449-c68598a75f514fda.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

4.3ä»£ç éƒ¨åˆ†

```
#import "UITableController.h"
#import <StoreKit/StoreKit.h>

@interface UITableController () <SKProductsRequestDelegate, UITableViewDelegate, UITableViewDataSource, SKPaymentTransactionObserver>

/** æ‰€æœ‰å•†å“ */
@property (nonatomic, strong) NSArray *products;
@end

@implementation UITableController

- (void)viewDidLoad {
    [super viewDidLoad];
    
    [self requestProducts];

}

// è¯·æ±‚å¯å–å•†å“
- (void)requestProducts {
    
    // 1.ä»æœåŠ¡å™¨è¯·æ±‚æ‰€æœ‰å•†å“çš„ProductIds
    NSString *filePath = [[NSBundle mainBundle] pathForResource:@"iapdemo.plist" ofType:nil];
    NSArray *productArray = [NSArray arrayWithContentsOfFile:filePath];
    
    // 2.è·å–productId
    NSArray *productIdArray = [productArray valueForKeyPath:@"productId"];
    
    // 3.è¯·æ±‚å¯å–çš„å•†å“
    NSSet *productIdSet = [NSSet setWithArray:productIdArray];
    SKProductsRequest *request = [[SKProductsRequest alloc] initWithProductIdentifiers:productIdSet];
    request.delegate = self;
    [request start];
}

- (void)viewWillAppear:(BOOL)animated
{
    [super viewWillAppear:animated];
    
    // æ·»åŠ è§‚å¯Ÿè€…
    [[SKPaymentQueue defaultQueue] addTransactionObserver:self];
}

- (void)viewWillDisappear:(BOOL)animated
{
    [super viewWillDisappear:animated];
    
    // ç§»é™¤è§‚å¯Ÿè€…
    [[SKPaymentQueue defaultQueue] removeTransactionObserver:self];
}


#pragma mark - å®ç°SKProductsRequestçš„ä»£ç†æ–¹æ³•
// è¯·æ±‚åˆ°å¯å–å•†å“çš„ç»“æœ
- (void)productsRequest:(SKProductsRequest *)request didReceiveResponse:(SKProductsResponse *)response
{
    // 1.å±•ç¤ºå•†å“
    self.products = [response.products sortedArrayWithOptions:NSSortConcurrent usingComparator:^NSComparisonResult(SKProduct *obj1, SKProduct *obj2) {
        return [obj1.price compare:obj2.price];
    }];
    
    // 2.åˆ·æ–°è¡¨æ ¼
    [self.tableView reloadData];
}

// è¯·æ±‚å¤±è´¥
- (void)request:(SKRequest *)request didFailWithError:(NSError *)error {

    NSLog(@"%@", [error localizedDescription]);
}

// è¯·æ±‚ç»“æŸ
- (void)requestDidFinish:(SKRequest *)request {

    NSLog(@"è¯·æ±‚ç»“æŸ");
}


#pragma mark - å®ç°tableViewçš„æ•°æ®æºå’Œä»£ç†æ–¹æ³•
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    return self.products.count;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    static NSString *ID = @"productCellId";
    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:ID];
    if (cell == nil) {
        cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleSubtitle reuseIdentifier:ID];
    }
    
    // 1.å–å‡ºæ¨¡å‹
    SKProduct *product = self.products[indexPath.row];
    
    // 2.ç»™cellè®¾ç½®æ•°æ®
    cell.textLabel.text = product.localizedTitle;
    cell.detailTextLabel.text = [NSString stringWithFormat:@"ä»·æ ¼:%@", product.price];
    
    return cell;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    // 1.å–å‡ºæ¨¡å‹
    SKProduct *product = self.products[indexPath.row];
    
    // 2.è´­ä¹°å•†å“
    [self buyProduct:product];
}

#pragma mark - è´­ä¹°å•†å“
- (void)buyProduct:(SKProduct *)product
{
    // 1.åˆ›å»ºç¥¨æ®
    SKPayment *payment = [SKPayment paymentWithProduct:product];
    
    // 2.å°†ç¥¨æ®åŠ å…¥åˆ°äº¤æ˜“é˜Ÿåˆ—ä¸­
    [[SKPaymentQueue defaultQueue] addPayment:payment];
}

#pragma mark - å®ç°SKPaymentQueueçš„å›è°ƒæ–¹æ³•
// ç›‘å¬è´­ä¹°ç»“æœ
- (void)paymentQueue:(SKPaymentQueue *)queue updatedTransactions:(NSArray *)transactions
{
    for (SKPaymentTransaction *transation in transactions) {
        switch (transation.transactionState) {
            case SKPaymentTransactionStatePurchasing:
                NSLog(@"æ­£åœ¨äº¤æ˜“");
                break;
                
            case SKPaymentTransactionStatePurchased:
                NSLog(@"äº¤æ˜“æˆåŠŸ");
                
                // å°†äº¤æ˜“ä»äº¤æ˜“é˜Ÿåˆ—ä¸­ç§»é™¤, å¦åˆ™ä¼šéªŒè¯ä¸é€šè¿‡,ä»¥ä¸‹å‡ ä¸ªéƒ½å¾—ç§»é™¤
                [queue finishTransaction:transation];
                break;
                
            case SKPaymentTransactionStateFailed:
                NSLog(@"äº¤æ˜“å¤±è´¥");
                [queue finishTransaction:transation];
                break;
                
            case SKPaymentTransactionStateRestored:
                NSLog(@"è´­ä¹°è¿‡è¯¥å•†å“");
                [queue finishTransaction:transation];
                break;
                
            case SKPaymentTransactionStateDeferred:
                NSLog(@"æœªå†³å®š");
                break;
            default:
                break;
        }
    }
}

- (void)dealloc {

    [[SKPaymentQueue defaultQueue] removeTransactionObserver:self];
}
```

å¦å¤–ä½¿ç”¨è¿™ä¸ªæ–¹æ³•å³å¯æ¢å¤è´­ä¹°

```
[[SKPaymentQueue defaultQueue] removeTransactionObserver:self];
```



---